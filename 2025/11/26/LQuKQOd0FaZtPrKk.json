{"nodes":[{"parameters":{},"id":"4aaa745d-3f32-4fed-8185-076bc47f9aa9","name":"ğŸ¯ Execute Workflow Trigger","type":"n8n-nodes-base.executeWorkflowTrigger","typeVersion":1,"position":[-1136,16]},{"parameters":{"content":"## âœï¸ GÃ©nÃ©ration de Script\n\n**EntrÃ©es :**\n- projectId (depuis orchestrateur)\n- Transcripts (depuis Module 1)\n\n**Actions :**\n1. GÃ©nÃ©rer 10 titres SEO\n2. CrÃ©er plan du script\n3. Recherche web enrichissement\n4. GÃ©nÃ©rer script complet (few-shot)\n5. DÃ©couper en sÃ©quences\n\n**Sorties :**\n- Script complet\n- SÃ©quences individuelles","height":420,"width":350,"color":6},"id":"ef20a5b5-b103-4515-a496-047968814f40","name":"âœï¸ MODULE 2 - GÃ‰NÃ‰RATION SCRIPT","type":"n8n-nodes-base.stickyNote","typeVersion":1,"position":[-1344,-288]},{"parameters":{"operation":"getAll","documentId":{"__rl":true,"mode":"id","value":"={{ $json.spreadsheetId }}"}},"id":"2289f43e-9d3f-4528-a95b-d0c2455d5b2f","name":"ğŸ“– Lire Transcripts","type":"n8n-nodes-base.googleSheets","typeVersion":4.5,"position":[-896,16]},{"parameters":{"operation":"getAll","documentId":{"__rl":true,"mode":"id","value":"={{ $json.spreadsheetId }}"}},"id":"6d725a16-3b76-42f8-a231-c1241036d2b4","name":"âš™ï¸ Lire Config Projet","type":"n8n-nodes-base.googleSheets","typeVersion":4.5,"position":[-896,224]},{"parameters":{"mode":"combine","combineBy":"combineAll","options":{}},"id":"e3176202-1ecf-46ab-a9c4-9f3c366c3cd8","name":"ğŸ”— Fusionner DonnÃ©es","type":"n8n-nodes-base.merge","typeVersion":3,"position":[-656,16]},{"parameters":{"jsCode":"// Examples few-shot pour le style du script\nconst fewShotExamples = [\n  {\n    input: \"CrÃ©er une introduction sur l'IA\",\n    output: \"Bonjour Ã  tous et bienvenue ! Aujourd'hui, nous plongeons dans le monde fascinant de l'intelligence artificielle. Vous vous Ãªtes dÃ©jÃ  demandÃ© comment les machines apprennent ? Restez avec moi, car nous allons dÃ©couvrir ensemble les secrets de cette rÃ©volution technologique.\"\n  },\n  {\n    input: \"Expliquer un concept technique\",\n    output: \"Parlons maintenant du machine learning. Imaginez que vous enseignez Ã  un enfant Ã  reconnaÃ®tre des fruits. Vous lui montrez des pommes, des oranges, des bananes. Avec le temps, l'enfant apprend. C'est exactement le principe du machine learning.\"\n  },\n  {\n    input: \"Conclure une section\",\n    output: \"VoilÃ , nous venons de voir les bases essentielles. Mais ce n'est que le dÃ©but ! Dans la prochaine partie, nous allons approfondir et voir des applications concrÃ¨tes qui vont vous surprendre.\"\n  }\n];\n\nconst transcript = $('ğŸ“– Lire Transcripts').first().json.transcript || '';\nconst config = $('âš™ï¸ Lire Config Projet').first().json;\n\nreturn [{\n  json: {\n    fewShotExamples: fewShotExamples,\n    sourceTranscript: transcript.slice(0, 2000), // Premier 2000 chars\n    topic: config.topic,\n    tone: config.tone,\n    targetDuration: config.duration,\n    language: config.language,\n    projectId: config.projectId\n  }\n}];"},"id":"79e75b1a-4104-4b8f-8742-0d31446db69c","name":"ğŸ“ PrÃ©parer Few-Shot Examples","type":"n8n-nodes-base.code","typeVersion":2,"position":[-416,16]},{"parameters":{"method":"POST","url":"https://api.openai.com/v1/chat/completions","authentication":"genericCredentialType","genericAuthType":"httpHeaderAuth","sendHeaders":true,"headerParameters":{"parameters":[{"name":"Content-Type","value":"application/json"}]},"sendBody":true,"specifyBody":"json","jsonBody":"={\n  \"model\": \"gpt-4\",\n  \"messages\": [\n    {\n      \"role\": \"system\",\n      \"content\": \"Tu es un expert YouTube SEO. CrÃ©e 10 titres accrocheurs, optimisÃ©s SEO.\"\n    },\n    {\n      \"role\": \"user\",\n      \"content\": \"Sujet: {{ $json.topic }}. DurÃ©e: {{ $json.targetDuration }}s. Ton: {{ $json.tone }}. Retourne JSON: {\\\"titles\\\": [...]}\"\n    }\n  ],\n  \"temperature\": 0.8,\n  \"max_tokens\": 500\n}","options":{}},"id":"4392c7de-1dcf-477a-8cb5-235a8aff9259","name":"ğŸ¯ GPT-4 - GÃ©nÃ©rer 10 Titres","type":"n8n-nodes-base.httpRequest","typeVersion":4.2,"position":[-176,-96]},{"parameters":{"jsCode":"const response = $json.choices[0].message.content;\nlet titlesData;\n\ntry {\n  const cleanJson = response.replace(/```json\\n?/g, '').replace(/```\\n?/g, '').trim();\n  titlesData = JSON.parse(cleanJson);\n} catch (error) {\n  titlesData = { titles: ['Titre par dÃ©faut'] };\n}\n\nreturn [{\n  json: {\n    titles: titlesData.titles,\n    selectedTitle: titlesData.titles[0]\n  }\n}];"},"id":"1b025242-cdb4-40bc-91bc-5ca982b5a184","name":"ğŸ“‹ Parser Titres","type":"n8n-nodes-base.code","typeVersion":2,"position":[64,-96]},{"parameters":{"method":"POST","url":"https://api.openai.com/v1/chat/completions","authentication":"genericCredentialType","genericAuthType":"httpHeaderAuth","sendHeaders":true,"headerParameters":{"parameters":[{"name":"Content-Type","value":"application/json"}]},"sendBody":true,"specifyBody":"json","jsonBody":"={\n  \"model\": \"gpt-4\",\n  \"messages\": [\n    {\n      \"role\": \"system\",\n      \"content\": \"Tu es un expert storytelling YouTube. CrÃ©e des plans structurÃ©s.\"\n    },\n    {\n      \"role\": \"user\",\n      \"content\": \"Plan pour {{ $('ğŸ“ PrÃ©parer Few-Shot Examples').first().json.targetDuration }}s sur {{ $('ğŸ“ PrÃ©parer Few-Shot Examples').first().json.topic }}. Structure: 1) Intro (10%) 2) Contexte (15%) 3) Contenu (60%) 4) Conclusion (15%). Retourne JSON: {\\\"outline\\\": [{\\\"section\\\": \\\"...\\\", \\\"duration\\\": ..., \\\"keyPoints\\\": [...]}]}\"\n    }\n  ],\n  \"temperature\": 0.7,\n  \"max_tokens\": 1500\n}","options":{}},"id":"9e5a398f-1b05-4dab-99f5-87180eef8921","name":"ğŸ“ GPT-4 - Plan du Script","type":"n8n-nodes-base.httpRequest","typeVersion":4.2,"position":[-176,144]},{"parameters":{"jsCode":"const response = $json.choices[0].message.content;\nlet outlineData;\n\ntry {\n  const cleanJson = response.replace(/```json\\n?/g, '').replace(/```\\n?/g, '').trim();\n  outlineData = JSON.parse(cleanJson);\n} catch (error) {\n  outlineData = { \n    outline: [\n      { section: 'Introduction', duration: 60, keyPoints: ['Hook'] },\n      { section: 'DÃ©veloppement', duration: 300, keyPoints: ['Point principal'] },\n      { section: 'Conclusion', duration: 60, keyPoints: ['CTA'] }\n    ] \n  };\n}\n\nreturn [{ json: { outline: outlineData.outline } }];"},"id":"540d443d-e755-4b83-9779-c55e2c5283ac","name":"ğŸ“‹ Parser Plan","type":"n8n-nodes-base.code","typeVersion":2,"position":[64,144]},{"parameters":{"url":"=https://serpapi.com/search?q={{ encodeURIComponent($('ğŸ“ PrÃ©parer Few-Shot Examples').first().json.topic) }}&api_key=YOUR_SERPAPI_KEY&num=3","options":{}},"id":"44d60878-632d-4dfc-88c6-5eda0023585a","name":"ğŸŒ Recherche Web (optionnel)","type":"n8n-nodes-base.httpRequest","typeVersion":4.2,"position":[304,16]},{"parameters":{"method":"POST","url":"https://api.openai.com/v1/chat/completions","authentication":"genericCredentialType","genericAuthType":"httpHeaderAuth","sendHeaders":true,"headerParameters":{"parameters":[{"name":"Content-Type","value":"application/json"}]},"sendBody":true,"specifyBody":"json","jsonBody":"={\n  \"model\": \"gpt-4\",\n  \"messages\": [\n    {\n      \"role\": \"system\",\n      \"content\": \"Tu es un scÃ©nariste YouTube expert. Style: {{ $('ğŸ“ PrÃ©parer Few-Shot Examples').first().json.tone }}. Expressions rÃ©currentes: 'Bonjour Ã  tous', 'Restez avec moi', 'N'oubliez pas de vous abonner'.\"\n    },\n    {\n      \"role\": \"user\",\n      \"content\": \"Examples:\\n{{ $('ğŸ“ PrÃ©parer Few-Shot Examples').first().json.fewShotExamples.map((ex, i) => `${i+1}. Input: ${ex.input}\\nOutput: ${ex.output}`).join('\\n\\n') }}\\n\\n---\\n\\nCrÃ©e un script COMPLET pour {{ $('ğŸ“ PrÃ©parer Few-Shot Examples').first().json.targetDuration }}s.\\nSujet: {{ $('ğŸ“ PrÃ©parer Few-Shot Examples').first().json.topic }}\\nTitre: {{ $('ğŸ“‹ Parser Titres').first().json.selectedTitle }}\\n\\nPlan:\\n{{ $('ğŸ“‹ Parser Plan').first().json.outline.map((s, i) => `${i+1}. ${s.section} (${s.duration}s): ${s.keyPoints.join(', ')}`).join('\\n') }}\\n\\nRetourne JSON: {\\\"script\\\": {\\\"introduction\\\": \\\"...\\\", \\\"sections\\\": [{\\\"title\\\": \\\"...\\\", \\\"content\\\": \\\"...\\\", \\\"duration\\\": ...}], \\\"conclusion\\\": \\\"...\\\"}}\"\n    }\n  ],\n  \"temperature\": 0.7,\n  \"max_tokens\": 4000\n}","options":{}},"id":"3799cc51-a5bc-435f-8d3a-51b2713b1038","name":"âœï¸ GPT-4 - Script Complet (Few-Shot)","type":"n8n-nodes-base.httpRequest","typeVersion":4.2,"position":[544,16]},{"parameters":{"jsCode":"const response = $json.choices[0].message.content;\nlet scriptData;\n\ntry {\n  const cleanJson = response.replace(/```json\\n?/g, '').replace(/```\\n?/g, '').trim();\n  scriptData = JSON.parse(cleanJson);\n} catch (error) {\n  return [{ json: { error: 'Erreur parsing script', rawResponse: response } }];\n}\n\nconst fullText = `${scriptData.script.introduction}\\n\\n${scriptData.script.sections.map(s => s.content).join('\\n\\n')}\\n\\n${scriptData.script.conclusion}`;\n\nreturn [{\n  json: {\n    projectId: $('ğŸ“ PrÃ©parer Few-Shot Examples').first().json.projectId,\n    script: scriptData.script,\n    fullScriptText: fullText,\n    wordCount: fullText.split(' ').length,\n    title: $('ğŸ“‹ Parser Titres').first().json.selectedTitle,\n    allTitles: $('ğŸ“‹ Parser Titres').first().json.titles.join(' | ')\n  }\n}];"},"id":"88f53041-8142-40b7-97fd-aa107a987829","name":"ğŸ“„ Parser Script","type":"n8n-nodes-base.code","typeVersion":2,"position":[784,16]},{"parameters":{"operation":"append","documentId":{"__rl":true,"mode":"id","value":"={{ $('ğŸ¯ Execute Workflow Trigger').item.json.spreadsheetId }}"},"sheetName":{"__rl":true,"mode":"list","value":"Scripts"},"columns":{"mappingMode":"defineBelow","value":{"projectId":"={{ $json.projectId }}","title":"={{ $json.title }}","fullScript":"={{ $json.fullScriptText }}","wordCount":"={{ $json.wordCount }}","allTitles":"={{ $json.allTitles }}","createdAt":"={{ $now }}"}},"options":{}},"id":"d982d1f3-0564-4def-9551-9f28d56d71ce","name":"ğŸ’¾ Sauvegarder Script","type":"n8n-nodes-base.googleSheets","typeVersion":4.5,"position":[1024,16]},{"parameters":{"jsCode":"const script = $('ğŸ“„ Parser Script').first().json.script;\nconst projectId = $('ğŸ“„ Parser Script').first().json.projectId;\nconst sequences = [];\nlet sequenceId = 1;\n\nfunction createSequences(content, sectionTitle, targetDuration = 8) {\n  const sentences = content.match(/[^.!?]+[.!?]+/g) || [content];\n  let currentSequence = '';\n  let currentDuration = 0;\n  \n  sentences.forEach((sentence, index) => {\n    const sentenceDuration = Math.ceil(sentence.split(' ').length / 2);\n    \n    if (currentDuration + sentenceDuration > targetDuration && currentSequence) {\n      sequences.push({\n        projectId: projectId,\n        sequenceId: sequenceId++,\n        section: sectionTitle,\n        text: currentSequence.trim(),\n        duration: currentDuration,\n        type: 'text'\n      });\n      currentSequence = sentence;\n      currentDuration = sentenceDuration;\n    } else {\n      currentSequence += ' ' + sentence;\n      currentDuration += sentenceDuration;\n    }\n    \n    if (index === sentences.length - 1 && currentSequence) {\n      sequences.push({\n        projectId: projectId,\n        sequenceId: sequenceId++,\n        section: sectionTitle,\n        text: currentSequence.trim(),\n        duration: currentDuration,\n        type: 'text'\n      });\n    }\n  });\n}\n\nif (script.introduction) createSequences(script.introduction, 'Introduction', 10);\nif (script.sections) script.sections.forEach(section => createSequences(section.content, section.title, 8));\nif (script.conclusion) createSequences(script.conclusion, 'Conclusion', 10);\n\nreturn sequences.map(seq => ({ json: seq }));"},"id":"be48a18e-03fd-4431-be58-2139fcd214e5","name":"âœ‚ï¸ DÃ©couper en SÃ©quences","type":"n8n-nodes-base.code","typeVersion":2,"position":[1264,16]},{"parameters":{"operation":"append","documentId":{"__rl":true,"mode":"id","value":"={{ $('ğŸ¯ Execute Workflow Trigger').item.json.spreadsheetId }}"},"sheetName":{"__rl":true,"mode":"list","value":"Sequences"},"columns":{"mappingMode":"defineBelow","value":{"projectId":"={{ $json.projectId }}","sequenceId":"={{ $json.sequenceId }}","section":"={{ $json.section }}","text":"={{ $json.text }}","duration":"={{ $json.duration }}","status":"pending"}},"options":{}},"id":"6222b247-69e9-450f-9ce4-28f76f6aabce","name":"ğŸ’¾ Sauvegarder SÃ©quences","type":"n8n-nodes-base.googleSheets","typeVersion":4.5,"position":[1504,16]},{"parameters":{"assignments":{"assignments":[{"id":"status","name":"status","type":"string","value":"success"},{"id":"module","name":"module","type":"string","value":"script"},{"id":"project-id","name":"projectId","type":"string","value":"={{ $('ğŸ“„ Parser Script').first().json.projectId }}"},{"id":"sequences-count","name":"sequencesCount","type":"number","value":"={{ $('âœ‚ï¸ DÃ©couper en SÃ©quences').all().length }}"}]},"options":{}},"id":"92054c7a-5869-4c86-9b5e-e75ea7619ca7","name":"âœ… Retourner RÃ©sultat","type":"n8n-nodes-base.set","typeVersion":3.4,"position":[1744,16]}],"connections":{"ğŸ¯ Execute Workflow Trigger":{"main":[[{"node":"ğŸ“– Lire Transcripts","type":"main","index":0},{"node":"âš™ï¸ Lire Config Projet","type":"main","index":0}]]},"ğŸ“– Lire Transcripts":{"main":[[{"node":"ğŸ”— Fusionner DonnÃ©es","type":"main","index":0}]]},"âš™ï¸ Lire Config Projet":{"main":[[{"node":"ğŸ”— Fusionner DonnÃ©es","type":"main","index":1}]]},"ğŸ”— Fusionner DonnÃ©es":{"main":[[{"node":"ğŸ“ PrÃ©parer Few-Shot Examples","type":"main","index":0}]]},"ğŸ“ PrÃ©parer Few-Shot Examples":{"main":[[{"node":"ğŸ¯ GPT-4 - GÃ©nÃ©rer 10 Titres","type":"main","index":0},{"node":"ğŸ“ GPT-4 - Plan du Script","type":"main","index":0}]]},"ğŸ¯ GPT-4 - GÃ©nÃ©rer 10 Titres":{"main":[[{"node":"ğŸ“‹ Parser Titres","type":"main","index":0}]]},"ğŸ“ GPT-4 - Plan du Script":{"main":[[{"node":"ğŸ“‹ Parser Plan","type":"main","index":0}]]},"ğŸ“‹ Parser Titres":{"main":[[{"node":"ğŸŒ Recherche Web (optionnel)","type":"main","index":0}]]},"ğŸ“‹ Parser Plan":{"main":[[{"node":"ğŸŒ Recherche Web (optionnel)","type":"main","index":0}]]},"ğŸŒ Recherche Web (optionnel)":{"main":[[{"node":"âœï¸ GPT-4 - Script Complet (Few-Shot)","type":"main","index":0}]]},"âœï¸ GPT-4 - Script Complet (Few-Shot)":{"main":[[{"node":"ğŸ“„ Parser Script","type":"main","index":0}]]},"ğŸ“„ Parser Script":{"main":[[{"node":"ğŸ’¾ Sauvegarder Script","type":"main","index":0}]]},"ğŸ’¾ Sauvegarder Script":{"main":[[{"node":"âœ‚ï¸ DÃ©couper en SÃ©quences","type":"main","index":0}]]},"âœ‚ï¸ DÃ©couper en SÃ©quences":{"main":[[{"node":"ğŸ’¾ Sauvegarder SÃ©quences","type":"main","index":0}]]},"ğŸ’¾ Sauvegarder SÃ©quences":{"main":[[{"node":"âœ… Retourner RÃ©sultat","type":"main","index":0}]]}},"pinData":{},"meta":null}